AWSTemplateFormatVersion: "2010-09-09"
Description: Using this to grant external consultants access to MWambalite test servers

Resources:
  ExternalAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      #PolicyName: EC2-SSM-Access 
      PolicyDocument: 
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - ssm:StartSession
          - ssm:SendCommand
          Resource: !Sub 'arn:aws:ec2:us-east-1:${AWS::AccountId}:instance/i-0284c493d9dc421cc'  

        - Effect: Allow
          Action:   
          - ssm:GetConnectionStatus
          - ssm:DescribeInstanceInformation
          Resource: "*"

        - Effect: Allow
          Action:
          - ssm:TerminateSession
          - ssm:ResumeSession
          Resource: arn:aws:ssm:*:*:session/${aws:username}-*

        - Effect: Allow
          Action:
          - ssm:StartSession
          Resource:
          - !Sub 'arn:aws:ec2:us-east-1:${AWS::AccountId}:instance/i-0284c493d9dc421cc'
          - arn:aws:ssm:*:*:document/AWS-StartSSHSession    

        # - Effect: Allow
        #   Action: 
        #   - ec2:DescribeInstances
        #   Resource: "*"
          # Condition: 
          #   StringEquals:
          #     ec2:ResourceTag/${TagKey}: Mwambalite-Testing  

  ExternalAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: "*"
                # - !Sub 'arn:aws:iam::${AWS::AccountId}:user/Devops' #this only create a trust policy. Grant users access to this role by adding permissions to it
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:        
        # - !GetAtt ExternalAccessPolicy.Arn
        - !Ref ExternalAccessPolicy
    DependsOn: ExternalAccessPolicy    

  ExternalAccessUserGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: External-Access
      Path: /

  ExternalUsersAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      #PolicyName: EC2-SSM-Access 
      Groups:
       - !Ref ExternalAccessUserGroup 
      PolicyDocument: 
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - sts:AssumeRole
          Resource: 
          - !GetAtt ExternalAccessRole.Arn
    DependsOn: ExternalAccessRole




